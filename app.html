<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Loja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%) !important;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 1.5rem;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            padding: 1rem 1.5rem;
            font-weight: 500;
            color: #6c757d;
            margin-right: 0;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-bottom-color: #0b5ed7;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background: rgba(13, 110, 253, 0.05);
            border-bottom-color: var(--primary-color);
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 1.5rem;
        }

        .stat-card {
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-card h5 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .stat-card small {
            opacity: 0.9;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .table {
            margin-bottom: 0;
            font-size: 0.95rem;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-top: none;
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 0.875rem 0.75rem;
            vertical-align: middle;
            border-color: #f1f3f4;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.03);
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            margin: 0 0.125rem;
            border: none;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 0.625rem 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
            transform: translateY(-1px);
        }

        .badge {
            font-size: 0.8rem;
            padding: 0.4em 0.6em;
            border-radius: 12px;
        }

        .low-stock {
            background: linear-gradient(135deg, #ffc107, #ffb300) !important;
            color: #856404 !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        .alert-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 320px;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            backdrop-filter: blur(2px);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.5;
            margin-bottom: 1rem;
            display: block;
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.25rem;
            }

            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .stat-card h5 {
                font-size: 1.25rem;
            }

            .table {
                font-size: 0.85rem;
            }

            .table th,
            .table td {
                padding: 0.5rem 0.25rem;
            }

            .card-body {
                padding: 1rem;
            }
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color), #0b5ed7);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0b5ed7, #0a58ca);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <div class="text-primary fw-semibold">Carregando dados...</div>
            <small class="text-muted">Aguarde enquanto inicializamos o sistema</small>
        </div>
    </div>

    <!-- App Principal -->
    <div id="appContainer">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <i class="fas fa-store me-2"></i>
                    <span>Controle de Loja</span>
                    <span class="badge bg-success ms-2" id="statusBadge">Online</span>
                </a>
                <div class="navbar-nav ms-auto align-items-center">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userDisplay">Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configura√ß√µes</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                        class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-4 px-3">
            <!-- Tabs de Navega√ß√£o -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                        type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos"
                        type="button" role="tab">
                        <i class="fas fa-box me-2"></i>Produtos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="movimentacoes-tab" data-bs-toggle="tab" data-bs-target="#movimentacoes"
                        type="button" role="tab">
                        <i class="fas fa-exchange-alt me-2"></i>Movimenta√ß√µes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios"
                        type="button" role="tab">
                        <i class="fas fa-file-alt me-2"></i>Relat√≥rios
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button"
                        role="tab">
                        <i class="fas fa-cog me-2"></i>Configura√ß√µes
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- DASHBOARD -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold small mb-1">Canal</label>
                                    <select id="filterCanal" class="form-select form-select-sm">
                                        <option value="todos">üëÅÔ∏è Todos</option>
                                        <option value="online">üõí Online</option>
                                        <option value="fisica">üè™ F√≠sica</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold small mb-1">Per√≠odo</label>
                                    <select id="filterPeriodo" class="form-select form-select-sm">
                                        <option value="">üìÖ Todos</option>
                                        <option value="hoje">üìÖ Hoje</option>
                                        <option value="semana">üìã Semana</option>
                                        <option value="mes">üìä M√™s</option>
                                        <option value="ano">üìà Ano</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold small mb-1">Data</label>
                                    <input type="date" id="filterData" class="form-control form-control-sm"
                                        style="display: none;">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold small mb-1">Status</label>
                                    <select id="filterStatus" class="form-select form-select-sm">
                                        <option value="todos">üìã Todos</option>
                                        <option value="saida">üì§ Vendas</option>
                                        <option value="entrada">üì• Compras</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" onclick="loadDashboard()">
                                        <i class="fas fa-sync-alt me-1"></i>Atualizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estat√≠sticas -->
                    <div class="row g-3 mb-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card bg-primary">
                                <h5 id="totalVendasHoje">0</h5>
                                <small><i class="fas fa-shopping-cart me-1"></i>Vendas Hoje</small>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card bg-success">
                                <h5 id="totalLucro">R$ 0,00</h5>
                                <small><i class="fas fa-chart-line me-1"></i>Lucro Total</small>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card bg-info">
                                <h5 id="totalProdutos">0</h5>
                                <small><i class="fas fa-boxes me-1"></i>Produtos</small>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card bg-warning">
                                <h5 id="totalEstoque">0</h5>
                                <small><i class="fas fa-warehouse me-1"></i>Estoque</small>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fico (placeholder) -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Vendas por Canal</h6>
                        </div>
                        <div class="card-body text-center p-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                                            style="width: 60px; height: 60px;">
                                            <i class="fas fa-store text-white" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div>
                                            <h5 id="vendasFisicas">0</h5>
                                            <small class="text-muted">Loja F√≠sica</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3"
                                            style="width: 60px; height: 60px;">
                                            <i class="fas fa-laptop text-white" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div>
                                            <h5 id="vendasOnline">0</h5>
                                            <small class="text-muted">Online</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3"
                                            style="width: 60px; height: 60px;">
                                            <i class="fas fa-coins text-white" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div>
                                            <h5 id="totalReceita">R$ 0,00</h5>
                                            <small class="text-muted">Receita Total</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela Principal -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-semibold">
                                <i class="fas fa-list me-2 text-primary"></i>
                                √öltimas Movimenta√ß√µes
                                <span class="badge bg-secondary ms-2" id="movCountBadge">0</span>
                            </h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="exportCSV()">
                                    <i class="fas fa-download me-1"></i>CSV
                                </button>
                                <button class="btn btn-outline-success" onclick="exportPDF()">
                                    <i class="fas fa-file-pdf me-1"></i>PDF
                                </button>
                                <button class="btn btn-outline-secondary" onclick="printTable()">
                                    <i class="fas fa-print me-1"></i>Imprimir
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 14%;"><i class="fas fa-clock me-1"></i>Data</th>
                                            <th style="width: 24%;"><i class="fas fa-tag me-1"></i>Produto</th>
                                            <th style="width: 10%;"><i class="fas fa-exchange-alt me-1"></i>Tipo</th>
                                            <th style="width: 8%;"><i class="fas fa-hashtag me-1"></i>Qtd</th>
                                            <th style="width: 12%;"><i class="fas fa-store me-1"></i>Canal</th>
                                            <th style="width: 16%;"><i class="fas fa-dollar-sign me-1"></i>Valor</th>
                                            <th style="width: 16%;"><i class="fas fa-chart-line me-1"></i>Lucro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dashboardTableBody">
                                        <tr class="table-info">
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                <span>Carregando movimenta√ß√µes...</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot class="table-dark">
                                        <tr>
                                            <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                            <td id="totalQuantidade" class="fw-bold">0</td>
                                            <td></td>
                                            <td id="totalValor" class="fw-bold text-primary">R$ 0,00</td>
                                            <td id="totalLucroFooter" class="fw-bold text-success">R$ 0,00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PRODUTOS -->
                <div class="tab-pane fade" id="produtos" role="tabpanel">
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-plus-circle me-2 text-success"></i>
                                        Novo Produto
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <form id="produtoForm" onsubmit="return false;">
                                        <div class="row g-3">
                                            <div class="col-md-8">
                                                <label class="form-label fw-semibold">Nome do Produto *</label>
                                                <input type="text" id="produtoNome" class="form-control"
                                                    placeholder="Ex: Camiseta Polo Azul" required>
                                                <div class="form-text">M√°ximo 100 caracteres</div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label fw-semibold">Categoria</label>
                                                <select id="produtoCategoria" class="form-select">
                                                    <option value="">Geral</option>
                                                    <option value="roupas">Roupas</option>
                                                    <option value="acessorios">Acess√≥rios</option>
                                                    <option value="eletronicos">Eletr√¥nicos</option>
                                                    <option value="outros">Outros</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold">Pre√ßo de Custo * <small
                                                        class="text-muted">(R$)</small></label>
                                                <input type="number" id="produtoCusto" class="form-control" step="0.01"
                                                    min="0" placeholder="0.00" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-semibold">Pre√ßo de Venda * <small
                                                        class="text-muted">(R$)</small></label>
                                                <input type="number" id="produtoVenda" class="form-control" step="0.01"
                                                    min="0" placeholder="0.00" required>
                                                <div id="lucroCalculado" class="form-text small text-success"
                                                    style="display: none;"></div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label fw-semibold">Estoque Inicial</label>
                                                <input type="number" id="produtoEstoque" class="form-control" min="0"
                                                    value="0" placeholder="0">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label fw-semibold">Ponto de Reposi√ß√£o</label>
                                                <input type="number" id="produtoMinEstoque" class="form-control" min="0"
                                                    value="5" placeholder="5">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label fw-semibold">C√≥digo de Barras</label>
                                                <input type="text" id="produtoBarcode" class="form-control"
                                                    placeholder="1234567890123">
                                            </div>
                                            <div class="col-12">
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-save me-1"></i>Salvar Produto
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                        onclick="clearProductForm()">
                                                        <i class="fas fa-times me-1"></i>Limpar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        Dicas R√°pidas
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info small" role="alert">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>O pre√ßo de venda</strong> deve ser maior que o custo para gerar lucro
                                    </div>
                                    <div class="alert alert-warning small" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Configure o <strong>ponto de reposi√ß√£o</strong> para receber alertas de estoque
                                        baixo
                                    </div>
                                    <div class="alert alert-success small" role="alert">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Use <strong>c√≥digos de barras</strong> para agilizar o registro de vendas
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-semibold">
                                <i class="fas fa-list me-2"></i>Lista de Produtos
                                <span class="badge bg-primary ms-2" id="produtosCount">0</span>
                            </h6>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-danger" onclick="deleteSelectedProducts()">
                                    <i class="fas fa-trash me-1"></i>Excluir Selecionados
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 4%;"><input type="checkbox" id="selectAllProducts"
                                                    onchange="toggleAllProducts()"></th>
                                            <th style="width: 28%;">Produto</th>
                                            <th style="width: 12%;">Custo</th>
                                            <th style="width: 12%;">Venda</th>
                                            <th style="width: 10%;">Estoque</th>
                                            <th style="width: 10%;">Lucro/Un</th>
                                            <th style="width: 12%;">Reposi√ß√£o</th>
                                            <th style="width: 12%;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="produtosTable">
                                        <!-- Conte√∫do carregado via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MOVIMENTA√á√ïES -->
                <div class="tab-pane fade" id="movimentacoes" role="tabpanel">
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-plus me-2 text-primary"></i>
                                        Registrar Movimenta√ß√£o
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <form id="movimentacaoForm" onsubmit="return false;">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label fw-semibold">Produto *</label>
                                                <select id="movProduto" class="form-select" required>
                                                    <option value="">Selecione um produto...</option>
                                                </select>
                                                <div id="produtoInfo" class="form-text small text-muted mt-1"></div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-semibold">Tipo *</label>
                                                <select id="movTipo" class="form-select" required>
                                                    <option value="entrada"><i
                                                            class="fas fa-sign-in-alt text-success me-1"></i>Entrada
                                                    </option>
                                                    <option value="saida"><i
                                                            class="fas fa-sign-out-alt text-danger me-1"></i>Sa√≠da
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-semibold">Canal *</label>
                                                <select id="movCanal" class="form-select" required>
                                                    <option value="online"><i
                                                            class="fas fa-globe text-info me-1"></i>Online</option>
                                                    <option value="fisica"><i
                                                            class="fas fa-store text-primary me-1"></i>F√≠sica</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label fw-semibold">Quantidade *</label>
                                                <input type="number" id="movQuantidade" class="form-control" value="1"
                                                    min="1" max="999" required>
                                                <div id="estoqueWarning" class="form-text small text-warning"
                                                    style="display: none;"></div>
                                            </div>
                                            <div class="col-md-2 d-grid">
                                                <button type="submit" class="btn btn-success h-100">
                                                    <i class="fas fa-save me-1"></i>Registrar
                                                </button>
                                            </div>
                                        </div>
                                    </form>

                                    <div class="mt-3">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Dica:</strong> Para sa√≠das, verifique se h√° estoque suficiente. O
                                            sistema bloqueia vendas com estoque insuficiente.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-history me-2"></i>√öltimas 5 Movimenta√ß√µes
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div id="recentMovements" class="list-group list-group-flush"
                                        style="max-height: 300px; overflow-y: auto;">
                                        <!-- Carregado via JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0 fw-semibold">
                                <i class="fas fa-history me-2 text-info"></i>
                                Hist√≥rico de Movimenta√ß√µes
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 14%;">Data</th>
                                            <th style="width: 25%;">Produto</th>
                                            <th style="width: 10%;">Tipo</th>
                                            <th style="width: 8%;">Qtd</th>
                                            <th style="width: 12%;">Canal</th>
                                            <th style="width: 16%;">Valor</th>
                                            <th style="width: 15%;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="movimentacoesTable">
                                        <!-- Carregado via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RELAT√ìRIOS -->
                <div class="tab-pane fade" id="relatorios" role="tabpanel">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                                        Resumo por Per√≠odo
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Data Inicial</label>
                                            <input type="date" id="relatorioDataInicio" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Data Final</label>
                                            <input type="date" id="relatorioDataFim" class="form-control">
                                        </div>
                                        <div class="col-12">
                                            <button class="btn btn-primary" onclick="generateRelatorio()">
                                                <i class="fas fa-chart-bar me-1"></i>Gerar Relat√≥rio
                                            </button>
                                        </div>
                                    </div>

                                    <div id="relatorioResultado" class="mt-4"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-file-export me-2 text-success"></i>
                                        Exportar Relat√≥rios
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        <button
                                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                            onclick="exportRelatorio('csv')">
                                            <div>
                                                <i class="fas fa-file-csv text-success me-2"></i>
                                                <strong>Exportar CSV</strong>
                                            </div>
                                            <small class="text-muted">Formato de planilha</small>
                                        </button>
                                        <button
                                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                            onclick="exportRelatorio('pdf')">
                                            <div>
                                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                                <strong>Exportar PDF</strong>
                                            </div>
                                            <small class="text-muted">Formato imprim√≠vel</small>
                                        </button>
                                        <button
                                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                            onclick="exportRelatorio('excel')">
                                            <div>
                                                <i class="fas fa-file-excel text-success me-2"></i>
                                                <strong>Exportar Excel</strong>
                                            </div>
                                            <small class="text-muted">Formato avan√ßado</small>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-chart-pie me-2 text-info"></i>
                                        Gr√°fico de Vendas por M√™s
                                    </h6>
                                </div>
                                <div class="card-body text-center p-4">
                                    <div id="vendasChart" style="height: 300px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURA√á√ïES -->
                <div class="tab-pane fade" id="config" role="tabpanel">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-user-cog me-2 text-primary"></i>
                                        Configura√ß√µes do Usu√°rio
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Usu√°rio Atual</label>
                                        <input type="text" class="form-control" value="admin" readonly>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <button class="btn btn-outline-primary w-100" onclick="changePassword()">
                                                <i class="fas fa-key me-1"></i>Mudar Senha
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-outline-warning w-100" onclick="resetPassword()">
                                                <i class="fas fa-undo me-1"></i>Resetar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-3 alert alert-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        A senha padr√£o √© <code>senha123</code>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-database me-2 text-info"></i>
                                        Armazenamento Local
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6 border-end">
                                            <div class="h5 text-primary mb-1" id="dbSize">0</div>
                                            <small class="text-muted">Tamanho DB</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 text-success mb-1" id="recordCount">0</div>
                                            <small class="text-muted">Registros</small>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-outline-danger w-100" onclick="optimizeDatabase()">
                                            <i class="fas fa-compress me-1"></i>Otimizar DB
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-download me-2 text-success"></i>
                                        Backup & Exporta√ß√£o
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="btn-group-vertical w-100" role="group">
                                        <button class="btn btn-outline-success mb-2" onclick="backupAllData('csv')">
                                            <i class="fas fa-file-csv me-2"></i>Exportar CSV Completo
                                        </button>
                                        <button class="btn btn-outline-primary mb-2" onclick="backupAllData('json')">
                                            <i class="fas fa-file-code me-2"></i>Exportar JSON
                                        </button>
                                        <button class="btn btn-outline-info mb-2" onclick="backupAllData('html')">
                                            <i class="fas fa-file-alt me-2"></i>Relat√≥rio HTML
                                        </button>
                                        <div class="mt-2">
                                            <label for="importFile" class="btn btn-outline-secondary w-100">
                                                <i class="fas fa-upload me-2"></i>Importar Dados
                                                <input type="file" id="importFile" accept=".json,.csv"
                                                    style="display: none;" onchange="importBackup(event)">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-cog me-2 text-warning"></i>
                                        Configura√ß√µes do Sistema
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="autoBackup" checked>
                                        <label class="form-check-label" for="autoBackup">
                                            Backup autom√°tico semanal
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="lowStockAlert" checked>
                                        <label class="form-check-label" for="lowStockAlert">
                                            Alertas de estoque baixo
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ponto de alerta de estoque</label>
                                        <input type="number" class="form-control" id="stockAlertLevel" value="10"
                                            min="1" max="100">
                                    </div>
                                    <button class="btn btn-outline-success w-100" onclick="saveSettings()">
                                        <i class="fas fa-save me-1"></i>Salvar Configura√ß√µes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                                        Limpeza de Dados ‚ö†Ô∏è
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-danger">
                                        <h6 class="alert-heading mb-3">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Aten√ß√£o!
                                        </h6>
                                        <p class="mb-3">Esta a√ß√£o ir√° <strong>apagar permanentemente</strong> todos os
                                            dados do sistema:</p>
                                        <ul class="list-unstyled mb-3">
                                            <li class="mb-1"><i class="fas fa-times-circle text-danger me-2"></i>Todos
                                                os produtos cadastrados</li>
                                            <li class="mb-1"><i class="fas fa-times-circle text-danger me-2"></i>Todo o
                                                hist√≥rico de movimenta√ß√µes</li>
                                            <li class="mb-1"><i
                                                    class="fas fa-times-circle text-danger me-2"></i>Relat√≥rios e
                                                estat√≠sticas</li>
                                            <li class="mb-1"><i
                                                    class="fas fa-times-circle text-danger me-2"></i>Configura√ß√µes
                                                personalizadas</li>
                                        </ul>
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-circle me-1"></i>
                                            <strong>IMPORTANTE:</strong> Fa√ßa backup antes de continuar!
                                        </div>
                                    </div>

                                    <div class="d-flex gap-3">
                                        <button class="btn btn-danger" onclick="clearAllData()">
                                            <i class="fas fa-trash-alt me-1"></i>Limpar Tudo
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="backupBeforeClear()">
                                            <i class="fas fa-download me-1"></i>Backup Primeiro
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card border-0">
                                <div class="card-body text-center text-muted p-4">
                                    <i class="fas fa-info-circle fa-2x mb-3 opacity-75"></i>
                                    <h6>Sistema de Controle de Loja v2.0</h6>
                                    <p class="mb-2">Desenvolvido para GitHub Pages | 100% Offline</p>
                                    <small>
                                        Dados armazenados localmente no navegador<br>
                                        <a href="#" class="text-decoration-none" onclick="showChangelog()">Ver hist√≥rico
                                            de vers√µes</a>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========================================
        // INICIALIZA√á√ÉO E BANCO DE DADOS
        // ========================================

        // Simples hash para demo (N√ÉO usar em produ√ß√£o)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // Banco de dados local
        const LojaDB = {
            data: null,
            init: function () {
                const defaultData = {
                    version: '2.0.1',
                    config: {
                        createdAt: new Date().toISOString(),
                        lastBackup: null,
                        settings: {
                            autoBackup: true,
                            lowStockAlert: true,
                            stockAlertLevel: 10
                        }
                    },
                    produtos: [
                        {
                            id: 'p001',
                            nome: 'Camiseta B√°sica Branca',
                            categoria: 'roupas',
                            preco_custo: 25.00,
                            preco_venda: 45.00,
                            estoque: 47,
                            min_estoque: 5,
                            barcode: '7891234567890',
                            createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: 'p002',
                            nome: 'Cal√ßa Jeans Slim',
                            categoria: 'roupas',
                            preco_custo: 80.00,
                            preco_venda: 150.00,
                            estoque: 28,
                            min_estoque: 3,
                            barcode: '7891234567891',
                            createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: 'p003',
                            nome: 'Cinto Couro Preto',
                            categoria: 'acessorios',
                            preco_custo: 35.00,
                            preco_venda: 75.00,
                            estoque: 12,
                            min_estoque: 2,
                            barcode: '7891234567892',
                            createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ],
                    movimentacoes: [
                        {
                            id: 'm001',
                            produtoId: 'p001',
                            tipo: 'saida',
                            quantidade: 3,
                            canal: 'fisica',
                            data: new Date().toISOString(),
                            valor: 135.00,
                            lucro: 60.00,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'm002',
                            produtoId: 'p002',
                            tipo: 'entrada',
                            quantidade: 10,
                            canal: 'online',
                            data: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                            valor: 800.00,
                            lucro: 0,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'm003',
                            produtoId: 'p001',
                            tipo: 'saida',
                            quantidade: 2,
                            canal: 'online',
                            data: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
                            valor: 90.00,
                            lucro: 40.00,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'm004',
                            produtoId: 'p003',
                            tipo: 'saida',
                            quantidade: 1,
                            canal: 'fisica',
                            data: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                            valor: 75.00,
                            lucro: 40.00,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'm005',
                            produtoId: 'p002',
                            tipo: 'saida',
                            quantidade: 1,
                            canal: 'online',
                            data: new Date(Date.now() - 8 * 60 * 60 * 1000).toISOString(),
                            valor: 150.00,
                            lucro: 70.00,
                            createdAt: new Date().toISOString()
                        }
                    ]
                };

                const saved = localStorage.getItem('controle_loja_v2');
                if (saved) {
                    try {
                        this.data = { ...defaultData, ...JSON.parse(saved) };
                    } catch (e) {
                        console.warn('Dados corrompidos, usando padr√£o');
                        this.data = defaultData;
                    }
                } else {
                    this.data = defaultData;
                }

                this.save();
                console.log('‚úÖ Banco de dados inicializado com', this.data.produtos.length, 'produtos');
            },

            save: function () {
                try {
                    localStorage.setItem('controle_loja_v2', JSON.stringify(this.data));
                    return true;
                } catch (e) {
                    console.error('Erro ao salvar dados:', e);
                    return false;
                }
            },

            getProdutos: function () {
                return this.data.produtos || [];
            },

            getMovimentacoes: function (filtros = {}) {
                let movs = [...(this.data.movimentacoes || [])];

                if (filtros.canal && filtros.canal !== 'todos') {
                    movs = movs.filter(m => m.canal === filtros.canal);
                }

                if (filtros.status && filtros.status !== 'todos') {
                    movs = movs.filter(m => m.tipo === filtros.status);
                }

                if (filtros.periodo) {
                    const hoje = new Date();
                    let inicio;

                    switch (filtros.periodo) {
                        case 'hoje':
                            inicio = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                            break;
                        case 'semana':
                            const diaSemana = hoje.getDay();
                            inicio = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() - diaSemana);
                            break;
                        case 'mes':
                            inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                            break;
                        case 'ano':
                            inicio = new Date(hoje.getFullYear(), 0, 1);
                            break;
                    }

                    movs = movs.filter(m => new Date(m.data) >= inicio);
                }

                // Ordenar por data descendente
                movs.sort((a, b) => new Date(b.data) - new Date(a.data));

                return movs;
            },

            addProduto: function (produto) {
                const id = 'p' + Date.now().toString(36) + Math.random().toString(36).substr(2);
                const novoProduto = {
                    id,
                    ...produto,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                this.data.produtos.unshift(novoProduto);
                this.save();
                return novoProduto;
            },

            updateProduto: function (id, updates) {
                const index = this.data.produtos.findIndex(p => p.id === id);
                if (index === -1) return false;

                this.data.produtos[index] = {
                    ...this.data.produtos[index],
                    ...updates,
                    updatedAt: new Date().toISOString()
                };

                this.save();
                return true;
            },

            deleteProduto: function (id) {
                this.data.produtos = this.data.produtos.filter(p => p.id !== id);
                this.data.movimentacoes = this.data.movimentacoes.filter(m => m.produtoId !== id);
                this.save();
                return true;
            },

            addMovimentacao: function (mov) {
                const produto = this.data.produtos.find(p => p.id === mov.produtoId);
                if (!produto) return { success: false, error: 'Produto n√£o encontrado' };

                if (mov.tipo === 'saida' && produto.estoque < mov.quantidade) {
                    return { success: false, error: `Estoque insuficiente. Dispon√≠vel: ${produto.estoque}` };
                }

                const id = 'm' + Date.now().toString(36) + Math.random().toString(36).substr(2);
                const novaMov = {
                    id,
                    ...mov,
                    data: mov.data || new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    valor: mov.tipo === 'saida' ? produto.preco_venda * mov.quantidade : 0,
                    lucro: mov.tipo === 'saida' ? (produto.preco_venda - produto.preco_custo) * mov.quantidade : 0
                };

                this.data.movimentacoes.unshift(novaMov);

                // Atualizar estoque
                if (mov.tipo === 'saida') {
                    produto.estoque -= mov.quantidade;
                } else {
                    produto.estoque += mov.quantidade;
                }
                produto.updatedAt = new Date().toISOString();

                this.save();
                return { success: true, movimentacao: novaMov };
            },

            getStats: function () {
                const produtos = this.getProdutos();
                const movimentacoes = this.getMovimentacoes({ periodo: 'hoje' });

                const vendasHoje = movimentacoes.filter(m => m.tipo === 'saida');
                const totalVendasHoje = vendasHoje.length;
                const totalLucroHoje = vendasHoje.reduce((sum, m) => sum + m.lucro, 0);
                const totalProdutos = produtos.length;
                const totalEstoque = produtos.reduce((sum, p) => sum + p.estoque, 0);
                const vendasFisicas = movimentacoes.filter(m => m.canal === 'fisica' && m.tipo === 'saida').length;
                const vendasOnline = movimentacoes.filter(m => m.canal === 'online' && m.tipo === 'saida').length;
                const totalReceita = movimentacoes.reduce((sum, m) => sum + m.valor, 0);

                return {
                    totalVendasHoje,
                    totalLucroHoje,
                    totalProdutos,
                    totalEstoque,
                    vendasFisicas,
                    vendasOnline,
                    totalReceita
                };
            },

            exportCSV: function () {
                const produtos = this.getProdutos();
                const movimentacoes = this.getMovimentacoes();

                let csv = 'TIPO,DADOS\n';

                // Produtos
                csv += 'PRODUTO,' + produtos.map(p =>
                    [p.nome, p.preco_custo, p.preco_venda, p.estoque, p.categoria || '', p.barcode || '']
                        .map(v => `"${String(v).replace(/"/g, '""')}"`).join('|')
                ).join(';') + '\n';

                // Movimenta√ß√µes
                csv += 'MOVIMENTACAO,' + movimentacoes.map(m => {
                    const produto = produtos.find(p => p.id === m.produtoId);
                    return [
                        m.produtoId,
                        m.tipo,
                        m.quantidade,
                        m.data,
                        m.canal,
                        m.valor,
                        m.lucro,
                        produto ? produto.nome : ''
                    ].map(v => `"${String(v).replace(/"/g, '""')}"`).join('|');
                }).join(';') + '\n';

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `relatorio-vendas-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
        };

        // ========================================
        // INICIALIZA√á√ÉO DA APLICA√á√ÉO
        // ========================================

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar banco
            LojaDB.init();

            // Verificar autentica√ß√£o
            const session = localStorage.getItem('loja_session');
            if (!session) {
                // Redirecionar para login
                window.location.href = 'index.html';
                return;
            }

            try {
                const sessionData = JSON.parse(session);
                if (sessionData.expires > Date.now()) {
                    // Autenticado - carregar app
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    setTimeout(() => {
                        initializeApp();
                    }, 1500);
                } else {
                    localStorage.removeItem('loja_session');
                    window.location.href = 'index.html';
                }
            } catch (e) {
                localStorage.removeItem('loja_session');
                window.location.href = 'index.html';
            }
        });

        function initializeApp() {
            // Configurar interface
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';

            // Carregar dados
            loadAllData();

            // Configurar event listeners
            setupEventListeners();

            // Atualizar UI
            updateUserDisplay();
            setupTabNavigation();

            console.log('‚úÖ App inicializado com sucesso');
        }

        function setupEventListeners() {
            // Filtros do dashboard
            document.getElementById('filterPeriodo').addEventListener('change', function () {
                const dataInput = document.getElementById('filterData');
                if (this.value) {
                    dataInput.style.display = 'block';
                    dataInput.value = new Date().toISOString().split('T')[0];
                } else {
                    dataInput.style.display = 'none';
                }
            });

            // Formul√°rio de produto
            document.getElementById('produtoForm').addEventListener('input', function () {
                calculateProductProfit();
            });

            document.getElementById('produtoForm').addEventListener('submit', function (e) {
                e.preventDefault();
                saveProduct();
            });

            // Formul√°rio de movimenta√ß√£o
            document.getElementById('movimentacaoForm').addEventListener('submit', function (e) {
                e.preventDefault();
                saveMovement();
            });

            document.getElementById('movProduto').addEventListener('change', function () {
                updateStockWarning();
            });

            document.getElementById('movTipo').addEventListener('change', function () {
                updateStockWarning();
            });

            document.getElementById('movQuantidade').addEventListener('input', function () {
                updateStockWarning();
            });

            // Sele√ß√£o de produtos
            document.getElementById('selectAllProducts').addEventListener('change', function () {
                document.querySelectorAll('#produtosTable input[type="checkbox"]').forEach(cb => {
                    cb.checked = this.checked;
                });
            });
        }

        // ========================================
        // FUN√á√ïES DO DASHBOARD
        // ========================================

        function loadDashboard() {
            showLoading(true);

            setTimeout(() => {
                const canal = document.getElementById('filterCanal').value;
                const periodo = document.getElementById('filterPeriodo').value;
                const data = document.getElementById('filterData').value;
                const status = document.getElementById('filterStatus').value;

                const filtros = { canal, status };
                if (periodo && data) {
                    filtros.periodo = periodo;
                    filtros.data = data;
                }

                const movimentacoes = LojaDB.getMovimentacoes(filtros);
                const produtos = LojaDB.getProdutos();

                // Atualizar estat√≠sticas
                const stats = LojaDB.getStats();
                updateDashboardStats(stats);

                // Preencher tabela
                populateDashboardTable(movimentacoes, produtos);

                // Atualizar badges
                document.getElementById('movCountBadge').textContent = movimentacoes.length;

                showLoading(false);
            }, 800);
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalVendasHoje').textContent = stats.totalVendasHoje;
            document.getElementById('totalLucro').textContent = formatCurrency(stats.totalLucroHoje);
            document.getElementById('totalProdutos').textContent = stats.totalProdutos;
            document.getElementById('totalEstoque').textContent = stats.totalEstoque;

            document.getElementById('vendasFisicas').textContent = stats.vendasFisicas;
            document.getElementById('vendasOnline').textContent = stats.vendasOnline;
            document.getElementById('totalReceita').textContent = formatCurrency(stats.totalReceita);
        }

        function populateDashboardTable(movimentacoes, produtos) {
            const tbody = document.getElementById('dashboardTableBody');

            if (movimentacoes.length === 0) {
                tbody.innerHTML = `
          <tr class="table-light">
            <td colspan="7" class="text-center py-5">
              <div class="empty-state">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <h5>Nenhuma movimenta√ß√£o encontrada</h5>
                <p class="mb-3">Ajuste os filtros acima ou registre sua primeira venda!</p>
                <button class="btn btn-primary btn-sm" onclick="loadMovimentacoesTab()">
                  <i class="fas fa-plus me-1"></i>Registrar Venda
                </button>
              </div>
            </td>
          </tr>
        `;
                updateTableFooter(0, 0, 0);
                return;
            }

            let totalQtd = 0, totalValor = 0, totalLucro = 0;

            const rows = movimentacoes.slice(0, 50).map(mov => {
                const produto = produtos.find(p => p.id === mov.produtoId);
                if (!produto) return null;

                const dataFormatada = new Date(mov.data).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const tipoIcon = mov.tipo === 'saida' ?
                    '<i class="fas fa-shopping-cart text-danger"></i>' :
                    '<i class="fas fa-truck text-success"></i>';

                const canalIcon = mov.canal === 'online' ?
                    '<i class="fas fa-globe text-info"></i>' :
                    '<i class="fas fa-store text-primary"></i>';

                totalQtd += mov.quantidade;
                totalValor += mov.valor;
                totalLucro += mov.lucro;

                return `
          <tr>
            <td><small class="text-muted">${dataFormatada}</small></td>
            <td>
              <div>
                <div class="fw-semibold">${escapeHtml(produto.nome)}</div>
                <small class="text-muted">C√≥d: ${mov.produtoId.slice(-6)}</small>
              </div>
            </td>
            <td>${tipoIcon} ${mov.tipo === 'saida' ? 'Venda' : 'Compra'}</td>
            <td class="fw-semibold">${mov.quantidade}</td>
            <td>${canalIcon} ${mov.canal === 'online' ? 'Online' : 'F√≠sica'}</td>
            <td class="fw-semibold text-primary">${formatCurrency(mov.valor)}</td>
            <td class="fw-semibold text-success">${formatCurrency(mov.lucro)}</td>
          </tr>
        `;
            }).filter(row => row !== null);

            tbody.innerHTML = rows.join('');
            updateTableFooter(totalQtd, totalValor, totalLucro);

            if (movimentacoes.length > 50) {
                const footer = document.querySelector('tfoot');
                footer.innerHTML += `
          <tr class="table-info">
            <td colspan="7" class="text-center py-2 small">
              <i class="fas fa-ellipsis-h me-1"></i>
              Mostrando ${Math.min(50, movimentacoes.length)} de ${movimentacoes.length} registros
              <button class="btn btn-link btn-sm p-0 ms-2 text-decoration-none" onclick="showAllRecords()">
                Ver todos
              </button>
            </td>
          </tr>
        `;
            }
        }

        function updateTableFooter(qtd, valor, lucro) {
            document.getElementById('totalQuantidade').textContent = qtd;
            document.getElementById('totalValor').textContent = formatCurrency(valor);
            document.getElementById('totalLucroFooter').textContent = formatCurrency(lucro);
        }

        function showLoading(show = true) {
            const spinner = document.querySelector('.spinner-border');
            if (show && spinner) {
                spinner.style.display
            }

        }

        function showAllRecords() {
            // Fun√ß√£o para mostrar todos os registros (sem limite)
            const todasMovs = LojaDB.getMovimentacoes({
                canal: document.getElementById('filterCanal').value,
                status: document.getElementById('filterStatus').value,
                periodo: document.getElementById('filterPeriodo').value,
                data: document.getElementById('filterData').value
            });

            const produtos = LojaDB.getProdutos();
            populateDashboardTable(todasMovs, produtos);

            showAlert('info', `Mostrando todos os ${todasMovs.length} registros`);
        }

        // ========================================
        // FUN√á√ïES DE PRODUTOS
        // ========================================

        function loadProducts() {
            const produtos = LojaDB.getProdutos();
            const tbody = document.getElementById('produtosTable');
            const countBadge = document.getElementById('produtosCount');

            countBadge.textContent = produtos.length;

            if (produtos.length === 0) {
                tbody.innerHTML = `
          <tr class="table-light">
            <td colspan="8" class="text-center py-5">
              <div class="empty-state">
                <i class="fas fa-box-open fa-3x mb-3 text-muted"></i>
                <h5>Nenhum produto cadastrado</h5>
                <p class="text-muted mb-3">Comece adicionando seu primeiro produto usando o formul√°rio acima</p>
                <button class="btn btn-primary" onclick="scrollToProductForm()">
                  <i class="fas fa-plus me-2"></i>Adicionar Primeiro Produto
                </button>
              </div>
            </td>
          </tr>
        `;
                return;
            }

            tbody.innerHTML = produtos.map((produto, index) => {
                const lucroUnit = produto.preco_venda - produto.preco_custo;
                const badgeClass = produto.estoque <= (produto.min_estoque || 5) ? 'low-stock badge-warning' : 'badge-success';
                const isLowStock = produto.estoque <= (produto.min_estoque || 5);

                return `
          <tr>
            <td>
              <input type="checkbox" class="product-checkbox" value="${produto.id}" onchange="updateProductSelection()">
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div class="avatar-sm rounded-circle bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-${getProductIcon(produto.categoria || 'geral')} text-primary" style="font-size: 1rem;"></i>
                  </div>
                </div>
                <div>
                  <div class="fw-semibold">${escapeHtml(produto.nome)}</div>
                  <small class="text-muted">
                    ${produto.categoria ? `<i class="fas fa-tag me-1"></i>${escapeHtml(produto.categoria)}` : ''}
                    ${produto.barcode ? `| ${produto.barcode}` : ''}
                  </small>
                </div>
              </div>
            </td>
            <td class="text-success fw-bold">R$ ${produto.preco_custo.toFixed(2)}</td>
            <td class="text-primary fw-bold">R$ ${produto.preco_venda.toFixed(2)}</td>
            <td>
              <span class="${badgeClass}">${produto.estoque}</span>
              ${isLowStock ? '<i class="fas fa-exclamation-triangle text-warning ms-1" title="Estoque baixo"></i>' : ''}
            </td>
            <td class="text-success fw-bold">R$ ${lucroUnit.toFixed(2)}</td>
            <td>
              <span class="badge bg-secondary">${produto.min_estoque || 5}</span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" onclick="editProduct('${produto.id}')" title="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-info" onclick="duplicateProduct('${produto.id}')" title="Duplicar">
                  <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteProduct('${produto.id}')" title="Excluir">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
            }).join('');

            updateProductSelection();
        }

        function scrollToProductForm() {
            document.getElementById('produtoForm').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
            document.getElementById('produtoNome').focus();
        }

        function calculateProductProfit() {
            const custo = parseFloat(document.getElementById('produtoCusto').value) || 0;
            const venda = parseFloat(document.getElementById('produtoVenda').value) || 0;
            const lucroDiv = document.getElementById('lucroCalculado');

            if (custo > 0 && venda > 0) {
                const lucro = venda - custo;
                const margem = ((lucro / venda) * 100).toFixed(1);

                lucroDiv.style.display = 'block';
                lucroDiv.innerHTML = `
          <i class="fas fa-calculator me-1"></i>
          Lucro: <strong>R$ ${lucro.toFixed(2)}</strong> 
          (<span class="${lucro > 0 ? 'text-success' : 'text-danger'}">${margem}%</span> margem)
        `;
            } else {
                lucroDiv.style.display = 'none';
            }
        }

        function saveProduct() {
            const nome = document.getElementById('produtoNome').value.trim();
            const custo = parseFloat(document.getElementById('produtoCusto').value);
            const venda = parseFloat(document.getElementById('produtoVenda').value);
            const estoque = parseInt(document.getElementById('produtoEstoque').value) || 0;
            const categoria = document.getElementById('produtoCategoria').value;
            const minEstoque = parseInt(document.getElementById('produtoMinEstoque').value) || 5;
            const barcode = document.getElementById('produtoBarcode').value.trim();

            // Valida√ß√µes
            if (!nome || custo === undefined || venda === undefined || custo < 0 || venda < 0) {
                showAlert('warning', 'Preencha todos os campos obrigat√≥rios corretamente');
                return;
            }

            if (custo >= venda) {
                showAlert('danger', 'O pre√ßo de venda deve ser maior que o pre√ßo de custo');
                return;
            }

            if (nome.length > 100) {
                showAlert('warning', 'O nome do produto deve ter no m√°ximo 100 caracteres');
                return;
            }

            const produtoData = {
                nome,
                preco_custo: custo,
                preco_venda: venda,
                estoque,
                categoria: categoria || null,
                min_estoque: minEstoque,
                barcode: barcode || null
            };

            const resultado = LojaDB.addProduto(produtoData);

            if (resultado) {
                showAlert('success', `Produto "${nome}" adicionado com sucesso!`);
                clearProductForm();
                loadProducts();
                loadDashboard();
                updateMovementSelect();
            } else {
                showAlert('danger', 'Erro ao salvar produto. Tente novamente.');
            }
        }

        function clearProductForm() {
            document.getElementById('produtoForm').reset();
            document.getElementById('produtoEstoque').value = '0';
            document.getElementById('produtoMinEstoque').value = '5';
            document.getElementById('lucroCalculado').style.display = 'none';
            document.getElementById('produtoNome').focus();
        }

        function editProduct(id) {
            const produto = LojaDB.getProdutos().find(p => p.id === id);
            if (!produto) {
                showAlert('warning', 'Produto n√£o encontrado');
                return;
            }

            // Preencher formul√°rio
            document.getElementById('produtoNome').value = produto.nome;
            document.getElementById('produtoCusto').value = produto.preco_custo;
            document.getElementById('produtoVenda').value = produto.preco_venda;
            document.getElementById('produtoEstoque').value = produto.estoque;
            document.getElementById('produtoCategoria').value = produto.categoria || '';
            document.getElementById('produtoMinEstoque').value = produto.min_estoque || 5;
            document.getElementById('produtoBarcode').value = produto.barcode || '';

            // Scroll para o form
            scrollToProductForm();

            // Mudar bot√£o para "Atualizar"
            const saveBtn = document.querySelector('#produtoForm button[type="submit"]');
            saveBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Atualizar Produto';
            saveBtn.dataset.editingId = id;

            calculateProductProfit();
        }

        function duplicateProduct(id) {
            const original = LojaDB.getProdutos().find(p => p.id === id);
            if (!original) return;

            // Criar c√≥pia
            const copia = {
                ...original,
                id: null, // Ser√° gerado novo ID
                nome: `C√≥pia de ${original.nome}`,
                createdAt: new Date().toISOString()
            };

            const resultado = LojaDB.addProduto(copia);

            if (resultado) {
                showAlert('success', `Produto duplicado com sucesso!`);
                loadProducts();
            }
        }

        function deleteProduct(id) {
            if (confirm('Tem certeza que deseja excluir este produto?\n\nEsta a√ß√£o tamb√©m remover√° todas as movimenta√ß√µes relacionadas.')) {
                const produto = LojaDB.getProdutos().find(p => p.id === id);
                if (produto) {
                    LojaDB.deleteProduto(id);
                    loadProducts();
                    loadDashboard();
                    updateMovementSelect();
                    showAlert('success', `"${produto.nome}" exclu√≠do com sucesso`);
                }
            }
        }

        function deleteSelectedProducts() {
            const selecionados = Array.from(document.querySelectorAll('.product-checkbox:checked'))
                .map(cb => cb.value);

            if (selecionados.length === 0) {
                showAlert('warning', 'Selecione pelo menos um produto para excluir');
                return;
            }

            if (confirm(`Deseja excluir ${selecionados.length} produto(s) selecionado(s)?`)) {
                let count = 0;
                selecionados.forEach(id => {
                    LojaDB.deleteProduto(id);
                    count++;
                });

                loadProducts();
                loadDashboard();
                updateMovementSelect();
                showAlert('success', `${count} produto(s) exclu√≠do(s) com sucesso`);
            }
        }

        function updateProductSelection() {
            const selecionados = document.querySelectorAll('.product-checkbox:checked').length;
            const total = document.querySelectorAll('.product-checkbox').length;
            const selectAll = document.getElementById('selectAllProducts');

            selectAll.indeterminate = selecionados > 0 && selecionados < total;
            selectAll.checked = selecionados === total && total > 0;

            // Atualizar bot√£o de excluir
            const deleteBtn = document.querySelector('.btn-outline-danger');
            if (selecionados > 0) {
                deleteBtn.innerHTML = `<i class="fas fa-trash me-1"></i>Excluir ${selecionados}`;
                deleteBtn.classList.remove('disabled');
            } else {
                deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Excluir Selecionados';
                deleteBtn.classList.add('disabled');
            }
        }

        function toggleAllProducts() {
            const isChecked = document.getElementById('selectAllProducts').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });
            updateProductSelection();
        }

        // ========================================
        // FUN√á√ïES DE MOVIMENTA√á√ïES
        // ========================================

        function updateMovementSelect() {
            const select = document.getElementById('movProduto');
            const produtos = LojaDB.getProdutos();

            select.innerHTML = '<option value="">üîç Selecione um produto...</option>';

            produtos.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = `${escapeHtml(produto.nome)} - R$ ${produto.preco_venda.toFixed(2)} (Est: ${produto.estoque})`;
                option.dataset.preco = produto.preco_venda;
                option.dataset.estoque = produto.estoque;
                select.appendChild(option);
            });
        }

        function updateStockWarning() {
            const produtoId = document.getElementById('movProduto').value;
            const tipo = document.getElementById('movTipo').value;
            const quantidade = parseInt(document.getElementById('movQuantidade').value) || 0;

            const warningDiv = document.getElementById('estoqueWarning');

            if (tipo === 'saida' && produtoId && quantidade > 0) {
                const produto = LojaDB.getProdutos().find(p => p.id === produtoId);
                if (produto && quantidade > produto.estoque) {
                    warningDiv.style.display = 'block';
                    warningDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
            <strong>Aten√ß√£o:</strong> Estoque dispon√≠vel: <strong>${produto.estoque}</strong>
          `;
                    document.querySelector('#movimentacaoForm button[type="submit"]').disabled = true;
                } else {
                    warningDiv.style.display = 'none';
                    document.querySelector('#movimentacaoForm button[type="submit"]').disabled = false;
                }
            } else {
                warningDiv.style.display = 'none';
                document.querySelector('#movimentacaoForm button[type="submit"]').disabled = false;
            }
        }

        function saveMovement() {
            const produtoId = document.getElementById('movProduto').value;
            const tipo = document.getElementById('movTipo').value;
            const quantidade = parseInt(document.getElementById('movQuantidade').value);
            const canal = document.getElementById('movCanal').value;

            if (!produtoId || !quantidade || quantidade <= 0) {
                showAlert('warning', 'Selecione um produto e quantidade v√°lida');
                return;
            }

            const resultado = LojaDB.addMovimentacao({
                produtoId,
                tipo,
                quantidade,
                canal
            });

            if (resultado.success) {
                const produto = LojaDB.getProdutos().find(p => p.id === produtoId);
                const acao = tipo === 'saida' ? 'vendido' : 'adicionado ao estoque';

                showAlert('success', `
          ‚úÖ ${quantidade}x "${produto.nome}" ${acao}!<br>
          <small>Novo estoque: ${resultado.novoEstoque || produto.estoque}</small>
        `);

                // Limpar form
                document.getElementById('movQuantidade').value = '1';
                document.getElementById('movProduto').selectedIndex = 0;

                // Recarregar dados
                loadDashboard();
                loadProducts();
                updateMovementSelect();
                updateStockWarning();
            } else {
                showAlert('danger', resultado.error);
            }
        }

        function loadRecentMovements() {
            const recent = LojaDB.getMovimentacoes().slice(0, 5);
            const produtos = LojaDB.getProdutos();
            const container = document.getElementById('recentMovements');

            if (recent.length === 0) {
                container.innerHTML = `
          <div class="list-group-item text-center text-muted py-4">
            <i class="fas fa-clock fa-2x mb-2 d-block"></i>
            <small>Nenhuma movimenta√ß√£o recente</small>
          </div>
        `;
                return;
            }

            container.innerHTML = recent.map(mov => {
                const produto = produtos.find(p => p.id === mov.produtoId);
                if (!produto) return '';

                const tempo = timeAgo(new Date(mov.data));
                const tipoClass = mov.tipo === 'saida' ? 'text-danger' : 'text-success';
                const canalIcon = mov.canal === 'online' ? 'fas fa-globe' : 'fas fa-store';

                return `
          <div class="list-group-item list-group-item-action border-start ${tipoClass}">
            <div class="d-flex w-100 justify-content-between">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <i class="fas fa-${mov.tipo === 'saida' ? 'shopping-cart' : 'truck-loading'} me-2 ${tipoClass}"></i>
                  <strong>${mov.quantidade}x ${escapeHtml(produto.nome)}</strong>
                </div>
                <small class="text-muted">
                  <i class="${canalIcon} me-1"></i>
                  ${mov.canal === 'online' ? 'Online' : 'Loja F√≠sica'} ‚Ä¢ 
                  <i class="fas fa-clock me-1"></i>${tempo}
                </small>
              </div>
              <span class="badge ${tipoClass}">${formatCurrency(mov.lucro || 0)}</span>
            </div>
          </div>
        `;
            }).join('');
        }

        function timeAgo(date) {
            const now = new Date();
            const diff = now - date;

            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d atr√°s`;
            if (hours > 0) return `${hours}h atr√°s`;
            if (minutes > 0) return `${minutes}min atr√°s`;
            return 'Agora';
        }

        function getProductIcon(categoria) {
            const icons = {
                'roupas': 'tshirt',
                'acessorios': 'gem',
                'eletronicos': 'mobile-alt',
                'cal√ßados': 'shoe-prints',
                'geral': 'box',
                'outros': 'cubes'
            };
            return icons[categoria] || 'box';
        }

        // ========================================
        // RELAT√ìRIOS
        // ========================================

        function generateRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;

            if (!dataInicio || !dataFim) {
                showAlert('warning', 'Selecione o per√≠odo do relat√≥rio');
                return;
            }

            if (new Date(dataInicio) > new Date(dataFim)) {
                showAlert('warning', 'A data inicial deve ser anterior √† data final');
                return;
            }

            const movimentacoes = LojaDB.getMovimentacoes({
                dataInicio,
                dataFim
            });
            const produtos = LojaDB.getProdutos();

            let totalVendas = 0, totalReceita = 0, totalLucro = 0;
            const relatorioPorProduto = {};

            movimentacoes.forEach(mov => {
                const produto = produtos.find(p => p.id === mov.produtoId);
                if (!produto || mov.tipo !== 'saida') return;

                totalVendas += mov.quantidade;
                totalReceita += mov.valor;
                totalLucro += mov.lucro;

                if (!relatorioPorProduto[produto.nome]) {
                    relatorioPorProduto[produto.nome] = { qtd: 0, valor: 0, lucro: 0 };
                }

                relatorioPorProduto[produto.nome].qtd += mov.quantidade;
                relatorioPorProduto[produto.nome].valor += mov.valor;
                relatorioPorProduto[produto.nome].lucro += mov.lucro;
            });

            const container = document.getElementById('relatorioResultado');
            container.innerHTML = `
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
              <i class="fas fa-file-alt me-2"></i>
              Relat√≥rio de ${new Date(dataInicio).toLocaleDateString('pt-BR')} a ${new Date(dataFim).toLocaleDateString('pt-BR')}
            </h6>
          </div>
          <div class="card-body">
            <div class="row text-center mb-4">
              <div class="col-md-4">
                <div class="card bg-light border-0 h-100">
                  <div class="card-body">
                    <i class="fas fa-shopping-cart fa-2x text-primary mb-2"></i>
                    <h5>${totalVendas}</h5>
                    <small class="text-muted">Itens Vendidos</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light border-0 h-100">
                  <div class="card-body">
                    <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                    <h5>${formatCurrency(totalReceita)}</h5>
                    <small class="text-muted">Receita Total</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light border-0 h-100">
                  <div class="card-body">
                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                    <h5>${formatCurrency(totalLucro)}</h5>
                    <small class="text-muted">Lucro Total</small>
                  </div>
                </div>
              </div>
            </div>
            
            <h6 class="mb-3">Vendas por Produto:</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Produto</th>
                    <th>Qtd Vendida</th>
                    <th>Receita</th>
                    <th>Lucro</th>
                    <th>Margem</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(relatorioPorProduto).map(([nome, dados]) => {
                const margem = ((dados.lucro / dados.valor) * 100).toFixed(1);
                return `
                      <tr>
                        <td><strong>${escapeHtml(nome)}</strong></td>
                        <td class="text-center">${dados.qtd}</td>
                        <td class="text-end">${formatCurrency(dados.valor)}</td>
                        <td class="text-end text-success">${formatCurrency(dados.lucro)}</td>
                        <td class="text-end ${margem >= 50 ? 'text-success' : 'text-warning'}">${margem}%</td>
                      </tr>
                    `;
            }).join('')}
                </tbody>
              </table>
            </div>
            
            <div class="mt-4 text-center">
              <button class="btn btn-success me-2" onclick="exportRelatorio('csv', {dataInicio, dataFim})">
                <i class="fas fa-download me-1"></i>Baixar CSV
              </button>
              <button class="btn btn-info" onclick="printRelatorio({dataInicio, dataFim})">
                <i class="fas fa-print me-1"></i>Imprimir
              </button>
            </div>
          </div>
        </div>
      `;
        }

        function exportRelatorio(formato, filtros) {
            if (formato === 'csv') {
                LojaDB.exportCSV();
            } else if (formato === 'pdf') {
                // Placeholder para PDF (usar jsPDF em produ√ß√£o)
                showAlert('info', 'Funcionalidade PDF em desenvolvimento');
            } else {
                showAlert('info', 'Formato n√£o suportado');
            }
        }

        function printRelatorio(filtros) {
            const printWindow = window.open('', '_blank');
            const relatorioHTML = generateRelatorioHTML(filtros);
            printWindow.document.write(relatorioHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function generateRelatorioHTML(filtros) {
            // Implementar gera√ß√£o HTML para impress√£o
            return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Relat√≥rio de Vendas</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            .total { font-weight: bold; background-color: #f9f9f9; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Relat√≥rio de Vendas</h1>
            <p>Per√≠odo: ${filtros.dataInicio} a ${filtros.dataFim}</p>
            <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
          </div>
          <!-- Tabela seria gerada aqui -->
          <p><em>Implementar tabela de relat√≥rio...</em></p>
        </body>
        </html>
      `;
        }

        // ========================================
        // CONFIGURA√á√ïES
        // ========================================

        function changePassword() {
            const novaSenha = prompt('Nova senha (m√≠nimo 6 caracteres):');
            if (!novaSenha || novaSenha.length < 6) {
                showAlert('warning', 'Senha deve ter pelo menos 6 caracteres');
                return;
            }

            const confirmacao = prompt('Confirme a nova senha:');
            if (novaSenha !== confirmacao) {
                showAlert('danger', 'As senhas n√£o coincidem');
                return;
            }

            // Atualizar sess√£o
            const session = JSON.parse(localStorage.getItem('loja_session') || '{}');
            session.passwordHash = simpleHash(novaSenha);
            localStorage.setItem('loja_session', JSON.stringify(session));

            showAlert('success', 'Senha alterada com sucesso! Use a nova senha no pr√≥ximo login.');
        }

        function resetPassword() {
            if (confirm('Redefinir para a senha padr√£o (senha123)?')) {
                const session = JSON.parse(localStorage.getItem('loja_session') || '{}');
                session.passwordHash = simpleHash('senha123');
                localStorage.setItem('loja_session', JSON.stringify(session));

                showAlert('success', 'Senha redefinida para "senha123"');
            }
        }

        function saveSettings() {
            const settings = {
                autoBackup: document.getElementById('autoBackup').checked,
                lowStockAlert: document.getElementById('lowStockAlert').checked,
                stockAlertLevel: parseInt(document.getElementById('stockAlertLevel').value)
            };

            LojaDB.data.config.settings = settings;
            LojaDB.save();

            showAlert('success', 'Configura√ß√µes salvas com sucesso');
        }

        function backupAllData(formato) {
            try {
                const data = {
                    config: LojaDB.data.config,
                    produtos: LojaDB.data.produtos,
                    movimentacoes: LojaDB.data.movimentacoes,
                    exportedAt: new Date().toISOString(),
                    totalProdutos: LojaDB.data.produtos.length,
                    totalMovimentacoes: LojaDB.data.movimentacoes.length
                };

                let content;
                let mimeType;
                let extension;

                if (formato === 'csv') {
                    content = LojaDB.exportCSV();
                    mimeType = 'text/csv';
                    extension = 'csv';
                } else if (formato === 'json') {
                    content = JSON.stringify(data, null, 2);
                    mimeType = 'application/json';
                    extension = 'json';
                } else {
                    content = generateBackupHTML(data);
                    mimeType = 'text/html';
                    extension = 'html';
                }

                const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                a.href = url;
                a.download = `backup-loja-${new Date().toISOString().split('T')[0]}.${extension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                LojaDB.data.config.lastBackup = new Date().toISOString();
                LojaDB.save();

                showAlert('success', `Backup ${formato.toUpperCase()} gerado com sucesso!`);
            } catch (e) {
                showAlert('danger', 'Erro ao gerar backup: ' + e.message);
            }
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const formato = file.name.split('.').pop().toLowerCase();

                const resultado = LojaDB.importData(content, formato);

                if (resultado.success) {
                    showAlert('success', `Backup importado! ${resultado.produtos} produtos e ${resultado.movimentacoes} movimenta√ß√µes adicionadas.`);
                    loadAllData();
                    event.target.value = '';
                } else {
                    showAlert('danger', `Erro na importa√ß√£o: ${resultado.error}`);
                }
            };

            reader.readAsText(file);
        }

        function optimizeDatabase() {
            const beforeSize = localStorage.getItem('controle_loja_v2').length;
            const produtos = LojaDB.getProdutos();
            const movimentacoes = LojaDB.getMovimentacoes();

            // Remover dados √≥rf√£os (movimenta√ß√µes sem produto)
            const validMovs = movimentacoes.filter(mov =>
                produtos.some(produto => produto.id === mov.produtoId)
            );

            LojaDB.data.movimentacoes = validMovs;
            LojaDB.save();

            const afterSize = localStorage.getItem('controle_loja_v2').length;
            const savings = ((beforeSize - afterSize) / 1024).toFixed(1);

            showAlert('success', `Banco otimizado! Liberados ${savings}KB. Removidas ${movimentacoes.length - validMovs.length} movimenta√ß√µes √≥rf√£s.`);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ESTA A√á√ÉO √â IRREVERS√çVEL!\n\n' +
                'Voc√™ perder√° permanentemente:\n' +
                '‚Ä¢ Todos os produtos cadastrados\n' +
                '‚Ä¢ Todo hist√≥rico de vendas\n' +
                '‚Ä¢ Estat√≠sticas e relat√≥rios\n\n' +
                'Deseja realmente continuar?')) {

                if (confirm('üî¥ CONFIRMA√á√ÉO FINAL\n\n' +
                    'Fa√ßa backup ANTES de confirmar!\n' +
                    'Esta √© sua √öLTIMA chance.\n\n' +
                    'Clique OK apenas se tiver certeza absoluta.')) {

                    localStorage.removeItem('controle_loja_v2');
                    localStorage.removeItem('loja_session');

                    showAlert('danger', 'Todos os dados foram APAGADOS permanentemente!');

                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            }
        }

        function backupBeforeClear() {
            backupAllData('json');
            setTimeout(() => {
                if (confirm('Backup criado! Agora deseja limpar os dados?')) {
                    clearAllData();
                }
            }, 1000);
        }

        // ========================================
        // UTILIT√ÅRIOS
        // ========================================

        function showAlert(tipo, mensagem, duracao = 5000) {
            // Remove alert anterior
            document.querySelectorAll('.alert-fixed').forEach(el => el.remove());

            const alertTypes = {
                'success': { icon: 'fa-check-circle', bg: 'success' },
                'danger': { icon: 'fa-exclamation-circle', bg: 'danger' },
                'warning': { icon: 'fa-exclamation-triangle', bg: 'warning' },
                'info': { icon: 'fa-info-circle', bg: 'info' }
            };

            const config = alertTypes[tipo] || alertTypes['info'];

            const alert = document.createElement('div');
            alert.className = `alert alert-${config.bg} alert-dismissible fade show alert-fixed shadow-lg`;
            alert.style.maxHeight = '80vh';
            alert.style.overflowY = 'auto';
            alert.innerHTML = `
        <div class="d-flex align-items-start">
          <i class="fas ${config.icon} me-3 mt-1 text-white" style="font-size: 1.2rem; opacity: 0.9;"></i>
          <div class="flex-grow-1">
            <div>${mensagem}</div>
          </div>
          <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="alert"></button>
        </div>
      `;

            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.classList.remove('show');
                    alert.classList.add('fade');
                    setTimeout(() => alert.remove(), 300);
                }
            }, duracao);
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatCurrency(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(valor);
        }

        // ========================================
        // INICIALIZA√á√ÉO FINAL
        // ========================================

        function loadAllData() {
            showLoading(true);

            // Carregar dados em paralelo
            Promise.all([
                new Promise(resolve => setTimeout(() => resolve(LojaDB.getProdutos()), 300)),
                new Promise(resolve => setTimeout(() => resolve(LojaDB.getMovimentacoes()), 500))
            ]).then(([produtos, movimentacoes]) => {
                // Atualizar UI
                updateUserDisplay();
                loadProducts();
                loadDashboard();
                loadRecentMovements();
                updateMovementSelect();

                showLoading(false);
                showAlert('success', `Bem-vindo! ${produtos.length} produtos e ${movimentacoes.length} movimenta√ß√µes carregados.`);
            });
        }

        function updateUserDisplay() {
            const session = JSON.parse(localStorage.getItem('loja_session') || '{}');
            document.getElementById('userDisplay').textContent = session.username || 'Admin';
        }

        function setupTabNavigation() {
            // Ativar tooltips do Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Auto-save a cada 30 segundos (apenas se houver mudan√ßas)
        let isDirty = false;
        setInterval(() => {
            if (isDirty) {
                LojaDB.save();
                isDirty = false;
                console.log('üíæ Auto-save executado');
            }
        }, 30000);

        // Detectar mudan√ßas
        document.addEventListener('input', () => {
            isDirty = true;
        });

        // Log de inicializa√ß√£o
        console.log('%cüöÄ Controle de Loja v2.0 - Inicializado com sucesso!',
            'color: #0d6efd; font-size: 16px; font-weight: bold;');
        console.log('üìä Produtos:', LojaDB.getProdutos().length);
        console.log('üìã Movimenta√ß√µes:', LojaDB.getMovimentacoes().length);
        console.log('üíæ Armazenamento local ativo');

        // Inicializar ap√≥s carregamento
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>

</html>
